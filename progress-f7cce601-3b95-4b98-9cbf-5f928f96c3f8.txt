# Progress Log
Run: f7cce601-3b95-4b98-9cbf-5f928f96c3f8
Task: FULL FINANCIAL MVP: canonical repo baseline; this session implements US-001 schema + migration + seed foundation, then US-002 repository/data-access layer.
Started: 2026-03-01 17:52 CET

## Codebase Patterns
- Database persistence uses Node built-in `node:sqlite` (`DatabaseSync`) with synchronous migration/seed scripts to keep setup dependency-light.
- Migration baseline is tracked in a `schema_migrations` table with monotonic integer versions.
- DB location is resolved by `FINANCIAL_DB_PATH` override (for tests) and defaults to `.data/financial.db` for local runs.
- Test isolation uses temp SQLite file paths per test case and verifies schema contracts via SQLite PRAGMA introspection.
- Tests use Node's built-in test runner (`node --test`) and repository scripts should remain minimal/commonjs-compatible.
- Data-access modules should normalize API-facing shape (camelCase fields) while mapping to SQL snake_case columns at query boundaries.
- Repository-level domain errors are modeled with stable `code` values (`VALIDATION_ERROR`, `NOT_FOUND`, `FK_VIOLATION`) so handlers can return consistent HTTP responses.
- API route modules follow dependency injection: route code takes provider instances, while provider selection is centralized in a factory driven by environment variables.
- HTTP errors should use a single `{ error: { code, message, details? } }` JSON contract so clients can handle failures consistently across endpoints.
- Route handlers should keep transport-level validation (allowed body fields, request shape) in route modules and rely on repository validation for domain-level constraints.
- Position-changing writes (buy/sell transactions) should run in an explicit SQLite `BEGIN`/`COMMIT` block so holding mutations and transaction inserts stay atomic.

---

## 2026-03-01 17:58 CET - US-001: Establish persistent financial schema and migration baseline
- Added DB infrastructure under `src/db/`:
  - `connection.js`: DB path resolution + foreign key enablement.
  - `migrate.js`: migration framework and baseline migration (version 1).
  - `seed.js`: deterministic fixture seed for demo portfolio data.
- Implemented migration SQL creating `portfolios`, `holdings`, and `transactions` with explicit PK/FK/not-null/check constraints.
- Added required lookup indexes:
  - `idx_holdings_portfolio_id`
  - `idx_transactions_portfolio_id`
  - `idx_transactions_holding_id`
- Added deterministic seed fixture (`portfolio-demo-001`, `holding-aapl-001`, and two transactions) for test usage.
- Added npm scripts:
  - `npm run migrate`
  - `npm run seed`
- Added `src/db/migrateAndSeed.test.js` to validate:
  - migration creates tables/FKs/indexes and schema version 1
  - seed inserts deterministic records and expected counts
- Ran validation commands successfully: `npm run typecheck`, `npm run build`, `npm test`.
- **Learnings:** Using explicit DB path override keeps tests hermetic and avoids coupling to workspace-local DB files.
---

## 2026-03-01 18:06 CET - US-002: Add repository/data-access layer for portfolios, holdings, and transactions
- Added `src/repositories/financialRepository.js` with dedicated repository functions for:
  - portfolios: `createPortfolio`, `listPortfolios`, `getPortfolioById`, `updatePortfolio`, `deletePortfolio`
  - holdings: `createHolding`, `listHoldingsByPortfolio`
  - transactions: `createTransaction`, `listTransactionsByPortfolio`
- Implemented repository-boundary normalization and validation:
  - trims required text fields
  - uppercases `symbol` and `baseCurrency`
  - normalizes dates to ISO strings
  - parses numeric inputs for `quantity`, `averageCost`, `price`, `totalAmount` and rejects invalid/negative values
- Added structured repository errors via `RepositoryError` with stable `code` values:
  - `VALIDATION_ERROR` for invalid input
  - `NOT_FOUND` for missing portfolio in get/update/delete
  - `FK_VIOLATION` for foreign key constraint failures in holdings/transactions inserts
- Covered schema delete behavior (ON DELETE CASCADE): deleting a portfolio removes related holdings and transactions.
- Added `src/repositories/financialRepository.test.js` covering CRUD, validation, FK violations, and cascade behavior.
- Ran validation commands successfully: `npm run typecheck`, `npm run build`, `npm test`.
- **Learnings:** Keeping SQL-column mapping isolated in repository methods preserves clean camelCase contracts for upper layers and simplifies handler testing.
---

## 2026-03-01 18:14 CET - US-003: Implement stock market data API endpoints with provider abstraction
- Added stock provider abstraction under `src/stocks/`:
  - `provider.js` factory selecting adapter via `STOCK_PROVIDER` env var.
  - `providers/stubProvider.js` deterministic quote/history adapter used by default and in tests.
  - `providers/liveProvider.js` optional live adapter (guarded by required env vars `STOCK_API_BASE_URL` and `STOCK_API_KEY`).
- Added stock route module `src/stocks/routes.js` implementing:
  - `GET /api/stocks/quote?symbol=`
  - `GET /api/stocks/history?symbol=&range=`
- Implemented query validation and shared error contract:
  - symbol validation with ticker pattern guard.
  - range validation against supported ranges (`1D`, `5D`, `1M`, `6M`, `1Y`).
  - uniform error responses in shape `{ error: { code, message, details? } }` with 400/500 status handling.
- Refactored `src/index.js` to expose `createApp()` with dependency-injected stock provider, keeping route code provider-agnostic.
- Added endpoint tests in `src/stocks/stockEndpoints.test.js` covering:
  - valid quote response contract
  - valid history response ordering and range behavior
  - invalid symbol/range errors using consistent JSON shape
  - env-driven provider selection and live-provider guardrails
- Ran validation commands successfully: `npm run typecheck`, `npm run build`, `npm test`.
- **Learnings:** Keeping provider selection in one factory and injecting into app creation allows environment-level switching without route changes and keeps endpoint tests deterministic.
---

## 2026-03-01 18:24 CET - US-004: Expose portfolio CRUD API endpoints
- Added shared API error helpers in `src/api/errors.js` and reused them from stock routes for a single error response contract.
- Added portfolio route module `src/portfolios/routes.js` implementing:
  - `GET /api/portfolios` (list)
  - `POST /api/portfolios` (create, returns 201 + resource)
  - `GET /api/portfolios/:id` (detail)
  - `PATCH /api/portfolios/:id` (allows only `name`, `baseCurrency`; rejects unknown fields with 400/`UNKNOWN_FIELDS`)
  - `DELETE /api/portfolios/:id` (explicit contract: 204 No Content on success, 404 when id is missing)
- Wired repository-backed portfolio routes into app bootstrap in `src/index.js` and enabled `express.json()` body parsing.
- Added endpoint integration tests in `src/portfolios/portfolioEndpoints.test.js` covering create/list/detail/update/delete, unknown-field rejection, and missing-id behavior.
- Ran validation commands successfully: `npm run typecheck`, `npm run build`, `npm test`.
- **Learnings:** Transport-level validation (unknown body keys) belongs at route boundary while repository validation remains source of truth for data/domain constraints.
---

## 2026-03-01 18:33 CET - US-005: Add holdings and transactions API with derived position updates
- Extended `src/portfolios/routes.js` with holdings and transaction endpoints:
  - `GET /api/portfolios/:id/holdings`
  - `GET /api/portfolios/:id/transactions`
  - `POST /api/portfolios/:id/transactions` (BUY/SELL only with unknown-field guard)
- Added API mapping for transaction/position errors:
  - `INSUFFICIENT_QUANTITY` returns HTTP 400 with error details
  - repository validation and FK errors are surfaced as 400 with stable error codes
- Enhanced `src/repositories/financialRepository.js` transaction behavior:
  - BUY/SELL transactions now run in one explicit DB transaction (`BEGIN`/`COMMIT`)
  - BUY creates or updates holding quantity and weighted average cost
  - SELL enforces available quantity and updates holding quantity
  - normalized numeric handling for quantity/price and computed `totalAmount` when omitted
  - deterministic transaction ordering changed to newest-first (`occurred_at DESC, created_at DESC, id DESC`)
- Added/updated tests:
  - `src/portfolios/portfolioHoldingsTransactions.test.js` for endpoint-level behavior (buy/sell persistence, holdings updates, oversell rejection, newest-first list)
  - `src/repositories/financialRepository.test.js` for repository atomic position updates and ordering guarantees
- Ran validation commands successfully: `npm run typecheck`, `npm run build`, `npm test`.
- **Learnings:** Keeping BUY/SELL business invariants in repository logic allows route handlers to stay thin while preserving atomicity and deterministic read models for UI consumers.
---
